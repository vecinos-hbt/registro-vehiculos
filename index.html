<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Registro de Vehículos - Hacienda Bahía Tongoy</title>
<style>
body { font-family: Arial, sans-serif; margin: 40px; background: #f4f4f4; }
h1 { text-align: center; }
form, .buscador, .tabla, .adminLogin { background: white; padding: 20px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
label { display: block; margin-top: 10px; }
input, select { width: 100%; padding: 8px; margin-top: 4px; border: 1px solid #ccc; border-radius: 4px; }
#patente, #buscarPatente { text-transform: uppercase; }
button { margin-top: 15px; padding: 10px 15px; border: none; background: #0078d7; color: white; font-size: 14px; border-radius: 5px; cursor: pointer; }
table { width: 100%; border-collapse: collapse; margin-top: 15px; }
th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
th { background: #0078d7; color: white; }
.pendiente { background: #fff3cd; }
.autorizado { background: #d4edda; }
.adminStatus { font-weight: bold; margin-top: 10px; color: green; }
</style>
</head>
<body>

<h1>Registro de Vehículos - Comunidad Hacienda Bahía Tongoy</h1>

<!-- Login administrador -->
<div class="adminLogin">
  <label>Email Admin:
    <input type="email" id="adminEmail">
  </label>
  <label>Contraseña:
    <input type="password" id="adminPass">
  </label>
  <button onclick="loginAdmin()">Iniciar Sesión Admin</button>
  <span id="estadoAdmin" class="adminStatus"></span>
  <button onclick="logoutAdmin()" style="display:none;" id="btnLogout">Cerrar Sesión</button>
</div>

<!-- Formulario -->
<form id="registroForm">
  <label>Propietario:<input type="text" id="dueno" required></label>
  <label>Parcela:<input type="text" id="parcela" required></label>
  <label>Patente vehículo:<input type="text" id="patente" required></label>

  <label>Marca:
    <select id="marca" required onchange="cargarModelos()">
      <option value="">Seleccione marca...</option>
      <option value="otro">Ingresar otro...</option>
    </select>
    <input type="text" id="marca_otro" placeholder="Escriba la marca" style="display:none; margin-top:5px;">
  </label>

  <label>Modelo:
    <select id="modelo" required onchange="toggleOtro('modelo')">
      <option value="">Seleccione modelo...</option>
      <option value="otro">Ingresar otro...</option>
    </select>
    <input type="text" id="modelo_otro" placeholder="Escriba el modelo" style="display:none; margin-top:5px;">
  </label>

  <label>Color:
    <select id="color" required onchange="toggleOtro('color')">
      <option value="">Seleccione color...</option>
      <option value="otro">Ingresar otro...</option>
    </select>
    <input type="text" id="color_otro" placeholder="Escriba el color" style="display:none; margin-top:5px;">
  </label>

  <label>Uso:
    <select id="uso" required>
      <option value="">Seleccione uso...</option>
      <option value="Personal">Personal</option>
      <option value="Visita">Visita</option>
      <option value="Trabajador">Trabajador</option>
    </select>
  </label>

  <button type="submit">Agregar Vehículo</button>
</form>

<!-- Buscador -->
<div class="buscador">
  <h2>Buscar por Patente</h2>
  <input type="text" id="buscarPatente" placeholder="Ingrese patente...">
  <button onclick="buscarVehiculo()">Buscar</button>
  <p id="resultadoBusqueda"></p>
</div>

<!-- Tabla -->
<div class="tabla">
  <h2>Listado de Vehículos</h2>
  <table id="tablaVehiculos">
    <thead>
      <tr>
        <th>Propietario</th><th>Parcela</th><th>Patente</th>
        <th>Marca</th><th>Modelo</th><th>Color</th><th>Uso</th><th>Estado</th><th>Acciones</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script>
// Config Firebase (reemplaza con los de tu proyecto)
const firebaseConfig = {
  apiKey: "AIzaSyAGQWXlQUY4_yOuM0vpal2Z_gGZL3LUyNU",
  authDomain: "registro-patentes-a3b2e.firebaseapp.com",
  projectId: "registro-patentes-a3b2e",
  storageBucket: "registro-patentes-a3b2e.firebasestorage.app",
  messagingSenderId: "1081438190905",
  appId: "1:1081438190905:web:813d8c37e644019184fce8"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const auth = firebase.auth();

let esAdmin = false;
const tabla = document.querySelector("#tablaVehiculos tbody");

// Mayúsculas patente
document.getElementById("patente").addEventListener("input", e => e.target.value = e.target.value.toUpperCase());
document.getElementById("buscarPatente").addEventListener("input", e => e.target.value = e.target.value.toUpperCase());

// Mostrar/Ocultar "otro"
function toggleOtro(campo) {
  const select = document.getElementById(campo);
  const input = document.getElementById(campo + "_otro");
  input.style.display = select.value === "otro" ? "block" : "none";
  input.required = select.value === "otro";
}

// Cargar marcas y colores al inicio
function cargarOpciones() {
  const marcaSel = document.getElementById("marca");
  marcaSel.innerHTML = '<option value="">Seleccione marca...</option><option value="otro">Ingresar otro...</option>';
  db.ref("catalogo").once("value").then(snapshot => {
    if(snapshot.exists()){
      Object.keys(snapshot.val()).forEach(marca=>{
        const opt=document.createElement("option");
        opt.value=marca; opt.textContent=marca;
        marcaSel.insertBefore(opt, marcaSel.querySelector('[value="otro"]'));
      });
    }
  });

  const colorSel=document.getElementById("color");
  colorSel.innerHTML='<option value="">Seleccione color...</option><option value="otro">Ingresar otro...</option>';
  db.ref("colores").once("value").then(snapshot=>{
    if(snapshot.exists()){
      snapshot.val().forEach(c=>{
        const opt=document.createElement("option");
        opt.value=c; opt.textContent=c;
        colorSel.insertBefore(opt, colorSel.querySelector('[value="otro"]'));
      });
    }
  });
}
cargarOpciones();

// Cargar modelos cuando cambia la marca
function cargarModelos() {
  const marca = document.getElementById("marca").value;
  const modeloSel = document.getElementById("modelo");
  modeloSel.innerHTML = '<option value="">Seleccione modelo...</option><option value="otro">Ingresar otro...</option>';
  document.getElementById("marca_otro").style.display = marca==="otro" ? "block":"none";

  if(marca && marca!=="otro"){
    db.ref("catalogo/"+marca).once("value").then(snapshot=>{
      if(snapshot.exists()){
        snapshot.val().forEach(m=>{
          const opt=document.createElement("option");
          opt.value=m; opt.textContent=m;
          modeloSel.insertBefore(opt, modeloSel.querySelector('[value="otro"]'));
        });
      }
    });
  }
}

// Guardar vehículo
document.getElementById("registroForm").addEventListener("submit", e => {
  e.preventDefault();
  let marca = document.getElementById("marca").value;
  if(marca==="otro") marca=document.getElementById("marca_otro").value;
  let modelo = document.getElementById("modelo").value;
  if(modelo==="otro") modelo=document.getElementById("modelo_otro").value;
  let color = document.getElementById("color").value;
  if(color==="otro") color=document.getElementById("color_otro").value;

  const patente = document.getElementById("patente").value.toUpperCase();
  db.ref("vehiculos/" + patente).set({
    dueno: document.getElementById("dueno").value,
    parcela: document.getElementById("parcela").value,
    patente,
    marca,
    modelo,
    color,
    uso: document.getElementById("uso").value,
    estado: "pendiente"
  });

  // Guardar marca nueva
  if(document.getElementById("marca").value==="otro"){
    db.ref("catalogo/"+marca).set([]);
  }
  // Guardar modelo nuevo
  if(document.getElementById("modelo").value==="otro"){
    db.ref("catalogo/"+marca).once("value").then(snapshot=>{
      let modelos=snapshot.val()||[];
      if(!modelos.includes(modelo)){
        modelos.push(modelo);
        db.ref("catalogo/"+marca).set(modelos);
      }
    });
  }
  // Guardar color nuevo
  if(document.getElementById("color").value==="otro"){
    db.ref("colores").once("value").then(snapshot=>{
      let colores=snapshot.val()||[];
      if(!colores.includes(color)){
        colores.push(color);
        db.ref("colores").set(colores);
      }
    });
  }

  e.target.reset();
  cargarOpciones();
});

// Renderizar tabla
function renderTabla(snapshot){
  tabla.innerHTML = "";
  snapshot.forEach(child => {
    const v = child.val();
    const fila = document.createElement("tr");
    fila.className = v.estado==="pendiente" ? "pendiente" : "autorizado";
    fila.innerHTML = `
      <td>${v.dueno}</td>
      <td>${v.parcela}</td>
      <td>${v.patente}</td>
      <td>${v.marca}</td>
      <td>${v.modelo}</td>
      <td>${v.color}</td>
      <td>${v.uso}</td>
      <td>${v.estado}</td>
      <td>
        ${esAdmin ? `
          <button onclick="autorizarVehiculo('${child.key}')">Autorizar</button>
          <button onclick="eliminarVehiculo('${child.key}')">Eliminar</button>
        ` : ""}
      </td>
    `;
    tabla.appendChild(fila);
  });
}

// Escuchar cambios en vehículos
db.ref("vehiculos").on("value", snapshot => renderTabla(snapshot));

// Buscar vehículo
function buscarVehiculo() {
  const patente = document.getElementById("buscarPatente").value.toUpperCase();
  db.ref("vehiculos/" + patente).once("value").then(snapshot => {
    const salida = document.getElementById("resultadoBusqueda");
    if(snapshot.exists()) {
      const v = snapshot.val();
      salida.textContent = `✅ ${v.marca} ${v.modelo}, dueño ${v.dueno}, parcela ${v.parcela}, uso ${v.uso}, estado ${v.estado}`;
    } else { salida.textContent="❌ No existe un vehículo con esa patente."; }
  });
}

// Login admin
function loginAdmin() {
  const email = document.getElementById("adminEmail").value;
  const pass = document.getElementById("adminPass").value;
  auth.signInWithEmailAndPassword(email, pass).catch(err => alert("Error: " + err.message));
}

// Logout admin
function logoutAdmin() {
  auth.signOut();
}

// Escuchar estado de sesión admin
auth.onAuthStateChanged(user => {
  esAdmin = !!user;
  document.getElementById("estadoAdmin").textContent = user ? "Admin activo ✅" : "";
  document.getElementById("btnLogout").style.display = user ? "inline-block" : "none";
  db.ref("vehiculos").once("value", snapshot=>renderTabla(snapshot));
});

// Autorizar y eliminar
function autorizarVehiculo(patente){ db.ref("vehiculos/"+patente+"/estado").set("autorizado"); }
function eliminarVehiculo(patente){ if(confirm(`Eliminar ${patente}?`)) db.ref("vehiculos/"+patente).remove(); }

</script>
</body>
</html>
